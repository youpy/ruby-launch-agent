#!/usr/bin/env ruby

require 'git-style-binary/command'

GitStyleBinary.command do
  short_desc "load/unload a periodic agent"
  banner <<-EOS
Usage: #{command.full_name} #{all_options_string} {full command}

Load/Unload a periodic launchd agent


EOS
  opt :interval, "causes the job to be started every N seconds", :required => true, :type => Integer
  opt :env, "additional environmental variables to be set before running the job. can specify multiple times", :type => String, :multi => true

  run do |command|
    abort 'full command must be supplised' if command.argv.empty?

    agent = LaunchAgent::Periodic.new(command.opts[:interval], *command.argv)

    agent['EnvironmentVariables'] = command.opts[:env].inject({}) do |memo, env|
      k, v = env.split('=')
      memo[k] = v
      memo
    end

    action = agent.loaded? ? :unload : :load
    agent.send(action)

    puts '%s "%s"' % [action, command.argv.join(' ')]
  end
end
